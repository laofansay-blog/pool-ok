<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å¥–æµç¨‹æµ‹è¯•</title>
    <link rel="stylesheet" href="web/styles/main.css">
    <style>
        body {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .test-title {
            color: white;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .flow-step {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .step-title {
            color: #4CAF50;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .step-content {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
        }
        
        .code-block {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
            overflow-x: auto;
        }
        
        .highlight {
            background: rgba(255, 193, 7, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            color: #FFC107;
        }
        
        .success {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .warning {
            color: #FF9800;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="test-title">ğŸ¯ ä¸­å¥–åçš„å®Œæ•´æµç¨‹éªŒè¯</h1>
        
        <div class="flow-step">
            <div class="step-title">
                <span>1ï¸âƒ£</span>
                <span>å¼€å¥–è§¦å‘</span>
            </div>
            <div class="step-content">
                <p><strong>è§¦å‘æ–¹å¼ï¼š</strong></p>
                <ul>
                    <li>ğŸ• <span class="highlight">å®šæ—¶å¼€å¥–</span>ï¼šæ¯5åˆ†é’Ÿè‡ªåŠ¨æ‰§è¡Œ <code>scheduled-lottery</code> å‡½æ•°</li>
                    <li>ğŸ‘¨â€ğŸ’¼ <span class="highlight">æ‰‹åŠ¨å¼€å¥–</span>ï¼šç®¡ç†å‘˜è°ƒç”¨ <code>draw-lottery</code> å‡½æ•°</li>
                    <li>ğŸ”„ <span class="highlight">é‡æ–°è®¡ç®—</span>ï¼šè°ƒç”¨ <code>recalculate-round</code> å‡½æ•°</li>
                </ul>
                <div class="code-block">
// ç”Ÿæˆå¼€å¥–æ•°å­—
const winningNumbers = generateWinningNumbers() // [2,5,3,1,6,3,7,9,2,8]
                </div>
            </div>
        </div>

        <div class="flow-step">
            <div class="step-title">
                <span>2ï¸âƒ£</span>
                <span>ä¸­å¥–åˆ¤æ–­</span>
            </div>
            <div class="step-content">
                <p><strong>åˆ¤æ–­é€»è¾‘ï¼š</strong></p>
                <ul>
                    <li>ğŸ“Š éå†æ¯ä¸ªæŠ•æ³¨è®°å½•çš„ <code>selected_numbers</code></li>
                    <li>ğŸ¯ æ£€æŸ¥æ¯ç»„æŠ•æ³¨æ˜¯å¦åŒ…å«å¯¹åº”ä½ç½®çš„å¼€å¥–æ•°å­—</li>
                    <li>âœ… <span class="success">ä¸­å¥–æ¡ä»¶ï¼šåªè¦æœ‰ä¸€ç»„ä¸­å¥–å°±ç®—ä¸­å¥–</span></li>
                </ul>
                <div class="code-block">
// ä¸­å¥–åˆ¤æ–­å‡½æ•°
function checkBetWinner(selectedNumbers, winningNumbers) {
  let winningGroups = 0
  for (let group = 1; group <= 10; group++) {
    const groupNumbers = selectedNumbers[group.toString()] || []
    if (groupNumbers.includes(winningNumbers[group - 1])) {
      winningGroups++
    }
  }
  return winningGroups >= 1 // åªè¦æœ‰ä¸€ç»„ä¸­å¥–å°±ç®—ä¸­å¥–
}
                </div>
            </div>
        </div>

        <div class="flow-step">
            <div class="step-title">
                <span>3ï¸âƒ£</span>
                <span>èµ”ä»˜è®¡ç®—</span>
            </div>
            <div class="step-content">
                <p><strong>è®¡ç®—å…¬å¼ï¼š</strong></p>
                <ul>
                    <li>ğŸ’° <span class="highlight">æŒ‰å•æ³¨è®¡ç®—</span>ï¼šä¸­å¥–æ³¨æ•° Ã— å•æ³¨é‡‘é¢ Ã— 9.8å€</li>
                    <li>ğŸ“‹ ä½¿ç”¨ <code>metadata.original_bets</code> ä¸­çš„è¯¦ç»†æŠ•æ³¨ä¿¡æ¯</li>
                    <li>ğŸ¯ <span class="success">ç¬¬183æœŸï¼š2æ³¨ä¸­å¥– Ã— 2å…ƒ Ã— 9.8 = 39.2å…ƒ</span></li>
                </ul>
                <div class="code-block">
// èµ”ä»˜è®¡ç®—å‡½æ•°
function calculateActualPayout(selectedNumbers, winningNumbers, metadata) {
  let totalPayout = 0
  metadata.original_bets.forEach(originalBet => {
    const { group, number, amount } = originalBet
    const winningNumber = winningNumbers[group - 1]
    if (number === winningNumber) {
      totalPayout += amount * 9.8 // ä¸­å¥–æ³¨ Ã— 9.8å€
    }
  })
  return totalPayout
}
                </div>
            </div>
        </div>

        <div class="flow-step">
            <div class="step-title">
                <span>4ï¸âƒ£</span>
                <span>æ•°æ®æ›´æ–°</span>
            </div>
            <div class="step-content">
                <p><strong>æ›´æ–°å†…å®¹ï¼š</strong></p>
                <ul>
                    <li>ğŸ“ <span class="highlight">æŠ•æ³¨è®°å½•</span>ï¼šæ›´æ–° <code>is_winner</code>ã€<code>actual_payout</code>ã€<code>status</code></li>
                    <li>ğŸ’³ <span class="highlight">ç”¨æˆ·ä½™é¢</span>ï¼šå¢åŠ ä¸­å¥–é‡‘é¢åˆ°ç”¨æˆ·è´¦æˆ·</li>
                    <li>ğŸ“Š <span class="highlight">è½®æ¬¡ç»Ÿè®¡</span>ï¼šæ›´æ–° <code>total_payout</code></li>
                </ul>
                <div class="code-block">
// æ›´æ–°æŠ•æ³¨è®°å½•
await supabaseClient.from('bets').update({
  is_winner: true,
  actual_payout: 39.2,
  status: 'settled',
  settled_at: new Date()
}).eq('id', bet.id)

// æ›´æ–°ç”¨æˆ·ä½™é¢
const newBalance = currentBalance + actualPayout
await supabaseClient.auth.admin.updateUserById(bet.user_id, {
  user_metadata: { balance: newBalance.toString() }
})
                </div>
            </div>
        </div>

        <div class="flow-step">
            <div class="step-title">
                <span>5ï¸âƒ£</span>
                <span>å‰ç«¯æ˜¾ç¤º</span>
            </div>
            <div class="step-content">
                <p><strong>æ˜¾ç¤ºæ›´æ–°ï¼š</strong></p>
                <ul>
                    <li>ğŸ† <span class="highlight">æŠ•æ³¨è®°å½•åˆ—è¡¨</span>ï¼šæ˜¾ç¤ºä¸­å¥–é«˜äº®å’Œæ”¶ç›Šé‡‘é¢</li>
                    <li>ğŸ“‹ <span class="highlight">æŠ•æ³¨è¯¦æƒ…é¡µ</span>ï¼šæ˜¾ç¤ºå®é™…èµ”ä»˜å’Œä¸­å¥–çŠ¶æ€</li>
                    <li>ğŸ’° <span class="highlight">ç”¨æˆ·ä½™é¢</span>ï¼šä¸ªäººä¸­å¿ƒæ˜¾ç¤ºæ›´æ–°åçš„ä½™é¢</li>
                    <li>ğŸ“ˆ <span class="highlight">å¼€å¥–å†å²</span>ï¼šé¦–é¡µæ˜¾ç¤ºæœ€æ–°å¼€å¥–ç»“æœ</li>
                </ul>
                <div class="code-block">
// å‰ç«¯ä¸­å¥–çŠ¶æ€åˆ¤æ–­
const stats = WinningNumbers.calculateWinningStats(selectedNumbers, winningNumbers)
const isWinner = stats.winningGroups >= 1

// æŠ•æ³¨è®°å½•é«˜äº®
&lt;tr class="${isWinner ? 'winner' : ''}"&gt;
  &lt;td&gt;${formatCurrency(actualPayout)}&lt;/td&gt;
&lt;/tr&gt;
                </div>
            </div>
        </div>

        <div class="flow-step">
            <div class="step-title">
                <span>âœ…</span>
                <span>ç¬¬183æœŸéªŒè¯ç»“æœ</span>
            </div>
            <div class="step-content">
                <p><strong>å®é™…æ‰§è¡Œç»“æœï¼š</strong></p>
                <ul>
                    <li>ğŸ² <span class="success">å¼€å¥–æ•°å­—</span>ï¼š[2, 5, 3, 1, 6, 3, 7, 9, 2, 8]</li>
                    <li>ğŸ¯ <span class="success">ä¸­å¥–åˆ¤æ–­</span>ï¼š1ç¬”æŠ•æ³¨ä¸­å¥–</li>
                    <li>ğŸ’° <span class="success">èµ”ä»˜è®¡ç®—</span>ï¼š2æ³¨ä¸­å¥– Ã— 2å…ƒ Ã— 9.8 = 39.2å…ƒ</li>
                    <li>ğŸ“ <span class="success">æŠ•æ³¨æ›´æ–°</span>ï¼šactual_payout = 39.2</li>
                    <li>ğŸ’³ <span class="success">ä½™é¢æ›´æ–°</span>ï¼šç”¨æˆ·ä½™é¢å¢åŠ 39.2å…ƒ</li>
                </ul>
                <div class="code-block">
âœ… é‡æ–°è®¡ç®—æˆåŠŸ!
ğŸ“Š ç»“ç®—ç»“æœ:
   è½®æ¬¡: ç¬¬183æœŸ
   å¼€å¥–æ•°å­—: 2, 5, 3, 1, 6, 3, 7, 9, 2, 8
   æ€»æŠ•æ³¨æ•°: 1
   ä¸­å¥–æŠ•æ³¨æ•°: 1
   æ€»èµ”ä»˜é‡‘é¢: Â¥39.20
                </div>
                <p class="success">ğŸ‰ æ‰€æœ‰æµç¨‹æ‰§è¡Œæ­£ç¡®ï¼ä¸­å¥–åå·²æ­£ç¡®æ›´æ–°æŠ•æ³¨çŠ¶æ€ã€æ”¶ç›Šé‡‘é¢å’Œç”¨æˆ·ä½™é¢ã€‚</p>
            </div>
        </div>

        <div class="flow-step">
            <div class="step-title">
                <span>ğŸ”</span>
                <span>éªŒè¯æ–¹æ³•</span>
            </div>
            <div class="step-content">
                <p><strong>å¦‚ä½•éªŒè¯ï¼š</strong></p>
                <ol>
                    <li>ğŸ” <span class="highlight">ç™»å½•è´¦æˆ·</span>ï¼šæŸ¥çœ‹ä¸ªäººä¸­å¿ƒçš„ä½™é¢æ˜¯å¦å¢åŠ äº†39.2å…ƒ</li>
                    <li>ğŸ“‹ <span class="highlight">æŠ•æ³¨è®°å½•</span>ï¼šæŸ¥çœ‹ç¬¬183æœŸæŠ•æ³¨è®°å½•æ˜¯å¦æ˜¾ç¤º"ä¸­å¥–"å’Œæ”¶ç›Š39.2å…ƒ</li>
                    <li>ğŸ“„ <span class="highlight">æŠ•æ³¨è¯¦æƒ…</span>ï¼šç‚¹å‡»è¯¦æƒ…æŸ¥çœ‹æ˜¯å¦æ˜¾ç¤ºå®é™…èµ”ä»˜39.2å…ƒ</li>
                    <li>ğŸ† <span class="highlight">é«˜äº®æ•ˆæœ</span>ï¼šä¸­å¥–è®°å½•æ˜¯å¦æœ‰ç»¿è‰²é«˜äº®å’Œå¥–æ¯å›¾æ ‡</li>
                </ol>
                <p class="warning">âš ï¸ å¦‚æœæ˜¾ç¤ºä¸æ­£ç¡®ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–é‡æ–°ç™»å½•ä»¥è·å–æœ€æ–°æ•°æ®ã€‚</p>
            </div>
        </div>
    </div>
</body>
</html>

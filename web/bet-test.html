<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‹æ³¨åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { background: #f5f5f5; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .test-button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .test-button:hover { background: #45a049; }
        .result { background: white; padding: 15px; border-radius: 4px; margin: 10px 0; white-space: pre-wrap; font-family: monospace; }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        .info { border-left: 4px solid #2196F3; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>ğŸ² ä¸‹æ³¨åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>ğŸ“‹ å½“å‰ç”¨æˆ·ä¿¡æ¯</h2>
        <div id="userInfo" class="result info">æ­£åœ¨åŠ è½½ç”¨æˆ·ä¿¡æ¯...</div>
        <button class="test-button" onclick="checkUser()">æ£€æŸ¥ç”¨æˆ·çŠ¶æ€</button>
        <button class="test-button" onclick="loginTestUser()">ç™»å½•æµ‹è¯•ç”¨æˆ·</button>
    </div>
    
    <div class="test-section">
        <h2>ğŸ¯ æµ‹è¯•ä¸‹æ³¨æ•°æ®</h2>
        <label>æµ‹è¯•æ•°æ® (JSONæ ¼å¼):</label>
        <textarea id="testData" rows="10">{
  "bets": [
    {"group": 1, "number": 1, "amount": 2},
    {"group": 1, "number": 2, "amount": 2},
    {"group": 2, "number": 3, "amount": 2}
  ],
  "totalAmount": 6,
  "userId": "test-user-id"
}</textarea>
        <button class="test-button" onclick="testPlaceBet()">æµ‹è¯•ä¸‹æ³¨</button>
        <div id="betResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ”§ æ•°æ®åº“æµ‹è¯•</h2>
        <button class="test-button" onclick="testDatabase()">æ£€æŸ¥æ•°æ®åº“è¡¨</button>
        <button class="test-button" onclick="testRounds()">æ£€æŸ¥è½®æ¬¡æ•°æ®</button>
        <button class="test-button" onclick="createTestUser()">åˆ›å»ºæµ‹è¯•ç”¨æˆ·</button>
        <div id="dbResult" class="result"></div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script>
        const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY)
        let currentUser = null
        
        // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
        async function checkUser() {
            const result = document.getElementById('userInfo')
            try {
                const { data: { user }, error } = await supabaseClient.auth.getUser()
                if (error) throw error
                
                if (user) {
                    currentUser = user
                    result.textContent = `âœ… ç”¨æˆ·å·²ç™»å½•:\nID: ${user.id}\né‚®ç®±: ${user.email}`
                    result.className = 'result success'
                    
                    // æ›´æ–°æµ‹è¯•æ•°æ®ä¸­çš„ç”¨æˆ·ID
                    const testDataEl = document.getElementById('testData')
                    const testData = JSON.parse(testDataEl.value)
                    testData.userId = user.id
                    testDataEl.value = JSON.stringify(testData, null, 2)
                } else {
                    result.textContent = 'âš ï¸ ç”¨æˆ·æœªç™»å½•'
                    result.className = 'result info'
                }
            } catch (error) {
                result.textContent = `âŒ æ£€æŸ¥ç”¨æˆ·å¤±è´¥: ${error.message}`
                result.className = 'result error'
            }
        }
        
        // ç™»å½•æµ‹è¯•ç”¨æˆ·
        async function loginTestUser() {
            const result = document.getElementById('userInfo')
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: 'test@example.com',
                    password: 'test123456'
                })
                
                if (error) throw error
                
                currentUser = data.user
                result.textContent = `âœ… ç™»å½•æˆåŠŸ:\nID: ${data.user.id}\né‚®ç®±: ${data.user.email}`
                result.className = 'result success'
                
                // æ›´æ–°æµ‹è¯•æ•°æ®
                const testDataEl = document.getElementById('testData')
                const testData = JSON.parse(testDataEl.value)
                testData.userId = data.user.id
                testDataEl.value = JSON.stringify(testData, null, 2)
                
            } catch (error) {
                result.textContent = `âŒ ç™»å½•å¤±è´¥: ${error.message}`
                result.className = 'result error'
            }
        }
        
        // æµ‹è¯•ä¸‹æ³¨
        async function testPlaceBet() {
            const result = document.getElementById('betResult')
            result.textContent = 'æ­£åœ¨æµ‹è¯•ä¸‹æ³¨...'
            
            try {
                const testDataEl = document.getElementById('testData')
                const testData = JSON.parse(testDataEl.value)
                
                console.log('å‘é€çš„æµ‹è¯•æ•°æ®:', testData)
                
                const response = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/place-bet`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`,
                        'apikey': CONFIG.SUPABASE_ANON_KEY
                    },
                    body: JSON.stringify(testData)
                })
                
                const responseText = await response.text()
                console.log('å“åº”çŠ¶æ€:', response.status)
                console.log('å“åº”å†…å®¹:', responseText)
                
                if (response.ok) {
                    result.textContent = `âœ… ä¸‹æ³¨æµ‹è¯•æˆåŠŸ!\n\nå“åº”:\n${responseText}`
                    result.className = 'result success'
                } else {
                    result.textContent = `âŒ ä¸‹æ³¨æµ‹è¯•å¤±è´¥ (${response.status}):\n\nå“åº”:\n${responseText}`
                    result.className = 'result error'
                }
                
            } catch (error) {
                result.textContent = `âŒ ä¸‹æ³¨æµ‹è¯•é”™è¯¯:\n${error.message}`
                result.className = 'result error'
            }
        }
        
        // æµ‹è¯•æ•°æ®åº“
        async function testDatabase() {
            const result = document.getElementById('dbResult')
            result.textContent = 'æ­£åœ¨æ£€æŸ¥æ•°æ®åº“...'
            
            try {
                const tables = ['users', 'rounds', 'bets']
                const results = []
                
                for (const table of tables) {
                    try {
                        const { data, error } = await supabaseClient
                            .from(table)
                            .select('*', { count: 'exact', head: true })
                        
                        if (error) {
                            results.push(`âŒ ${table}: ${error.message}`)
                        } else {
                            results.push(`âœ… ${table}: å­˜åœ¨`)
                        }
                    } catch (err) {
                        results.push(`âŒ ${table}: ${err.message}`)
                    }
                }
                
                result.textContent = results.join('\n')
                result.className = 'result info'
            } catch (error) {
                result.textContent = `âŒ æ•°æ®åº“æ£€æŸ¥å¤±è´¥: ${error.message}`
                result.className = 'result error'
            }
        }
        
        // æ£€æŸ¥è½®æ¬¡æ•°æ®
        async function testRounds() {
            const result = document.getElementById('dbResult')
            result.textContent = 'æ­£åœ¨æ£€æŸ¥è½®æ¬¡æ•°æ®...'
            
            try {
                const { data, error } = await supabaseClient
                    .from('rounds')
                    .select('*')
                    .eq('status', 'pending')
                    .limit(1)
                
                if (error) {
                    result.textContent = `âŒ è½®æ¬¡æŸ¥è¯¢å¤±è´¥: ${error.message}`
                    result.className = 'result error'
                } else if (data.length === 0) {
                    result.textContent = 'âš ï¸ æ²¡æœ‰æ‰¾åˆ°è¿›è¡Œä¸­çš„è½®æ¬¡'
                    result.className = 'result info'
                } else {
                    result.textContent = `âœ… æ‰¾åˆ°è¿›è¡Œä¸­çš„è½®æ¬¡:\n${JSON.stringify(data[0], null, 2)}`
                    result.className = 'result success'
                }
            } catch (error) {
                result.textContent = `âŒ è½®æ¬¡æ£€æŸ¥é”™è¯¯: ${error.message}`
                result.className = 'result error'
            }
        }
        
        // åˆ›å»ºæµ‹è¯•ç”¨æˆ·
        async function createTestUser() {
            const result = document.getElementById('dbResult')
            result.textContent = 'æ­£åœ¨åˆ›å»ºæµ‹è¯•ç”¨æˆ·...'
            
            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email: 'test@example.com',
                    password: 'test123456',
                    options: {
                        data: {
                            username: 'testuser',
                            full_name: 'Test User'
                        }
                    }
                })
                
                if (error) {
                    result.textContent = `âŒ åˆ›å»ºç”¨æˆ·å¤±è´¥: ${error.message}`
                    result.className = 'result error'
                } else {
                    result.textContent = `âœ… æµ‹è¯•ç”¨æˆ·åˆ›å»ºæˆåŠŸ:\nID: ${data.user?.id}\né‚®ç®±: ${data.user?.email}`
                    result.className = 'result success'
                }
            } catch (error) {
                result.textContent = `âŒ åˆ›å»ºç”¨æˆ·é”™è¯¯: ${error.message}`
                result.className = 'result error'
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
        window.addEventListener('load', () => {
            setTimeout(checkUser, 1000)
        })
    </script>
</body>
</html>
